# Работа с Kubernetes (curl)

## Описание

Инструмент [Kubernetes](https://kubernetes.io/) очень популярен в среде DevOPS и позиционируется как операционная система для контейнеров, где основные функции продукта - автоматический скейлинг, автоматизация деплоя, менеджмент контейнеров и т.д. С точки зрения системы, Kubernetes - это изолированные окружения (dedicated сервера, виртуальные машины) обеспечивающие runtime окружения для контейнеров и в свою очередь, эти окружения могут масштабироваться. Так, кубернетес кластер может состоять как из одного хоста (или виртуальной машины), так и от десятков и сотен окружений. С учетом тех плюсов, которые дает нам виртуализация (DRS, управление питанием, легкий способ унифицировать окружения на разном типе физических хостов), деплой Kubernetes зачастую очень выгодно выглядит  в виртуализированных средах, таких как MyB. Также, деплой Kubernetes в MyB - это один из примеров расширения API и использования инструментария по генерации gold образов, когда на любую систему на базе Linux была скопирована дистрибьюция Kubernetes для максимального быстрого бутстрапа сервиса.

Вы можете создавать любую конфигурацию кластера Kubernetes:

1) Одна виртуальная машина, совмещающая в себе роль master ( controller/control plane ) и worker. Этот тип кластера по-умолчанию при типовой установке MyB.
2) Разделение роли controller/control plane на отдельно выделенные виртуальные машины от роли worker ( рантайм контейнеров ). Поскольку это затрагивает множественное количество виртуальных машин, данный тип кластера возможно при добавлении дополнительных нод MyB в единый MyB кластер.


## Создание single node K8S

Для создания контейнера, используйте [endpoint](api.md): **'/api/v1/create/'**.

Минимальный payload для создания кластера Kubernetes:

```
{
  "image": "k8s",
  "init_masters": "1",
  "master_vm_ram": "2g",
  "master_vm_cpus": "1",
  "master_vm_imgsize": "20g",
  "pubkey": "ssh-ed25519 AAAA..XXX your@localhost",
 }
```

- (обязательный) параметр 'image' регулирует GOLD образ, который используем для заказа Kubernetes. Для базовой поставки MyB - это **'k8s'**;
- (обязательный) параметр 'init_masters' регулирует количество controller/control plane окружений кластера, минимальное кол-во - 1. Обычно создается нечеткное количество контроллеров для соблюдения кворума: **1, 3, 5, 7** ..;
- (обязательно) параметр 'master_vm_ram' регулирует объем оперативной памяти для каждой виртуальной машины с функциями 'controller';
- (обязательно) параметр 'master_vm_imgsize' регулирует объем дискового пространства для каждой виртуальной машины с функциями 'controller' (не путать с объемом дискового пространства для PV;
- (обязательно) параметр 'pubkey'. ваш публичный ключ. Используется для генерации CID-токена, а также для доступа в консоль MyB K8S;

Часть параметров также является обязательными, но в минимальном payload опущены, поскольку по-умолчанию выставлены наиболее подходящие параметры.

## Создание 



  "init_workers": "0",
  "master_vm_ram": "2g",
  "master_vm_cpus": "1",
  "master_vm_imgsize": "20g",
  "worker_vm_ram": "2g",
  "worker_vm_cpus": "1",
  "worker_vm_imgsize": "20g",
  "pv_enable": "0",
  "kubelet_master": "1",
  "email": "olevole@olevole.ru",
  "pubkey": "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINozWtPg+k91W7GIZf+n0oLcPwpHv0Bs8FV6sfgchmfs k1@mother.olevole.ru",
  "callback": "https://callback_api"
}
```

Например:

1)
```
cat > k8sjson <<EOF
{
}
```

2)
> curl --no-progress-meter -X POST -H "Content-Type: application/json" -d @jail.json http://HOST/api/v1/create/k1

Пример payload для создания kubernetes кластера:
```
{
}

```

Обратите внимание, что время на создания первого контейнера зависит от наличия образа 'jail' и качества вашего Internet соединения. 
Рекомендуется через запуск 'jail' в  шелл оболочки администраторской консоли сначала получить образ. Если вы этого не сделаете, при запросе на /create,
система автоматически сначала выкачает архив rootfs для FreeBSD, затем распакует на файловую систему и только после этого создаст и запустит контейнер. 
Все последующие запуски контейнеров будут происходить мгновенно.


## Статус Kubernetes

Для просмотра информации по контейнеру, используйте свой token/CID и [endpoint](api.md): **'/api/v1/status/'**, например:

1) Если не знаете свой токен, получите его из вашего pubkey:
>  md5sum -qs 'ssh-ed25519 AAAA..XXX your@localhost'
> 90af7aa8bc164240521753a105df6a05

2) Посмотреть информацию по контейнеру jail1, используя токен:
> curl -H cid:90af7aa8bc164240521753a105df6a05 http://HOST/api/v1/status/jail1

Среди информации по статусу окружения, вы можете найти порт (он может быть динамический, если используется expose портов) и IP адрес для соединения в контейнер через SSH.


## Удаление Kubernetes

Для удаления jail, используйте свой token/CID и [endpoint](api.md): **'/api/v1/status/'**, например:

1) Если не знаете свой токен, получите его из вашего pubkey:
>  md5sum -qs 'ssh-ed25519 AAAA..XXX your@localhost'
> 90af7aa8bc164240521753a105df6a05

2) Удалите контейнер с использованием вашего токена:
> curl -H cid:90af7aa8bc164240521753a105df6a05 http://HOST/api/v1/destroy/jail1


---

Дальше: [Работа с jail (CBSDfile)](jail_cbsdfile.md)
