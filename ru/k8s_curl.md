# Работа с Kubernetes (curl)

## Описание

Инструмент [Kubernetes](https://kubernetes.io/) очень популярен в среде DevOPS и позиционируется как операционная система для контейнеров, где основные функции продукта - автоматический скейлинг, автоматизация деплоя, менеджмент контейнеров и т.д. С точки зрения системы, Kubernetes - это изолированные окружения (dedicated сервера, виртуальные машины) обеспечивающие runtime окружения для контейнеров и в свою очередь, эти окружения могут масштабироваться. Так, кубернетес кластер может состоять как из одного хоста (или виртуальной машины), так и от десятков и сотен окружений. С учетом тех плюсов, которые дает нам виртуализация (DRS, управление питанием, легкий способ унифицировать окружения на разном типе физических хостов), деплой Kubernetes зачастую очень выгодно выглядит  в виртуализированных средах, таких как MyB. Также, деплой Kubernetes в MyB - это один из примеров расширения API и использования инструментария по генерации gold образов, когда на любую систему на базе Linux была скопирована дистрибьюция Kubernetes для максимального быстрого бутстрапа сервиса.

Вы можете создавать любую конфигурацию кластера Kubernetes:

1) Одна виртуальная машина, совмещающая в себе роль master ( controller/control plane ) и worker. Этот тип кластера по-умолчанию при типовой установке MyB.
2) Разделение роли controller/control plane на отдельно выделенные виртуальные машины от роли worker ( рантайм контейнеров ). Поскольку это затрагивает множественное количество виртуальных машин, данный тип кластера возможно при добавлении дополнительных нод MyB в единый MyB кластер.


## Создание single node K8S

Для создания контейнера, используйте [endpoint](api.md): **'/api/v1/create/'**.

Минимальный payload для создания кластера Kubernetes:

```
{
  "image": "k8s",
  "init_masters": "1",
  "master_vm_ram": "4g",
  "master_vm_cpus": "2",
  "master_vm_imgsize": "20g",
  "pubkey": "ssh-ed25519 AAAA..XXX your@localhost",
 }
```

- (обязательный) параметр 'image' регулирует GOLD образ, который используем для заказа Kubernetes. Для базовой поставки MyB - это **'k8s'**;
- (обязательный) параметр 'init_masters' регулирует количество controller/control plane окружений кластера, минимальное кол-во - 1. Обычно создается нечеткное количество контроллеров для соблюдения кворума: **1, 3, 5, 7** ..;
- (обязательный) параметр 'master_vm_ram' регулирует объем оперативной памяти для каждой виртуальной машины с функциями 'controller';
- (обязательный) параметр 'master_vm_cpus' регулирует число vCPU (ядер) для каждой виртуальной машины с функциями 'controller'. Минимальное число ядер для ВМ, выполняющей функции controller - **'1'** для dev среды и **'2'** - для продуктивной;
- (обязательный) параметр 'master_vm_imgsize' регулирует объем дискового пространства для каждой виртуальной машины с функциями 'controller' (не путать с объемом дискового пространства для PV;
- (обязательный) параметр 'pubkey'. ваш публичный ключ. Используется для генерации CID-токена, а также для доступа в консоль MyB K8S;

Часть параметров также является обязательными, но в минимальном payload опущены, поскольку по-умолчанию выставлены наиболее подходящие параметры.

Например, сохраните вышеупомянутый payload в качестве k8s.json и отправьте запрос на создание кластера с именем **'k1'**:

```
curl -X POST -H "Content-Type: application/json" -d @k8s.json http://HOST/api/v1/create/k1
```


## Создание multi node K8S 

:bangbang: | :information_source: Обратите внимание! Описываемые дополнительные параметры в payload работают в MyB кластере, состоящим из более одной физической ноды, поскольку в этом случае, kubernetes состоит из нескольких ВМ, поскольку создание мульти-нодового Kubenetes кластера на одной физической машине бессмысленнен с точки зрения отказоутсойчивости.
:---: | :---

Полный payload для создания Kubernetes кластеров может выглядеть следующим образом:

```
{
  "image": "k8s",
  "init_masters": "3",
  "init_workers": "3",
  "master_vm_ram": "2g",
  "master_vm_cpus": "2",
  "master_vm_imgsize": "20g",
  "worker_vm_ram": "16g",
  "worker_vm_cpus": "16",
  "worker_vm_imgsize": "20g",
  "pv_enable": "1",
  "kubelet_master": "0",
  "email": "your@example.com",
  "pubkey": "ssh-ed25519 AAAA..XXX your@localhost",
  "callback": "https://callback_api"
}
```

Описание других полей, ранее не рассмотренных:

- (обязательный) параметр 'init_workers' - регулирует количество ВМ с ролью 'worker'. Минимальное кол-во - 0, но в этом случае, параметр 'kubelet_master' всегда должен быть установлен в значение '1' (см. ниже), иначе вы не сможете деплоить контейнера.;
- (обязательный) параметр 'worker_vm_ram' регулирует объем оперативной памяти для каждой виртуальной машины с функциями 'worker';
- (обязательный) параметр 'worker_vm_cpus' регулирует число vCPU (ядер) для каждой виртуальной машины с функциями 'worker'. Минимальное число ядер для ВМ, выполняющей функции worker - **'1'**.
- (обязательный) параметр 'worker_vm_imgsize' регулирует объем дискового пространства для каждой виртуальной машины с функциями 'worker' (не путать с объемом дискового пространства для PV;
- (обязательный) параметр 'pv_enable', включить PV по-умолчанию ? '1' - да, '0' - нет. По-умолчанию, PV регистрируется автоматически при создании кластера;
- (обязательный) параметр 'kubelet_master' - совместить ли роль ВМ, выполняющего роль 'controller' с ролью 'worker';
- (необязательный) параметр 'email', на который придет kubeconfig и информация по работе с кластером при создании нового кластера;
- (необязательный) параметр 'callback', в котором можно указать URI/URL, например 'HTTP(s)://IP/myclu', на который API будет присылать события в формате json, которые происходят с кластером (например, вы можете отследить факт создания или удаления кластера, получив от API соответствующий запрос). Используется в основном для построения над MyB автоматизаций и более высоких абстракций;

## Статус Kubernetes кластера

Для просмотра информации по кластеру, используйте свой token/CID и [endpoint](api.md): **'/api/v1/status/'**, например:

1) Если не знаете свой токен, получите его из вашего pubkey:
>  md5sum -qs 'ssh-ed25519 AAAA..XXX your@localhost'
> 90af7aa8bc164240521753a105df6a05

2) Посмотреть информацию по контейнеру jail1, используя токен:
> curl -H cid:90af7aa8bc164240521753a105df6a05 http://HOST/api/v1/status/jail1

Среди информации по статусу kubernetes, вы можете найти адрес и порт для соединения в MyB контейнер на базе 'jail' через SSH, посредством которого вы можете получить доступ к PV/PVC Kubernetes, а также, использовать этот контейнер как 'jump' хост, в котором есть такие утилиты, как 'kubectl', 'helm' и 'k9s'. Пример:




## Удаление Kubernetes

Для удаления kubernetes, используйте свой token/CID и [endpoint](api.md): **'/api/v1/status/'**, например:

1) Если не знаете свой токен, получите его из вашего pubkey:
>  md5sum -qs 'ssh-ed25519 AAAA..XXX your@localhost'
> 90af7aa8bc164240521753a105df6a05

2) Удалите контейнер с использованием вашего токена:
> curl -H cid:90af7aa8bc164240521753a105df6a05 http://HOST/api/v1/destroy/k1


---

Дальше: [Работа с jail (CBSDfile)](jail_cbsdfile.md)
